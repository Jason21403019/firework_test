# CSRF 驗證機制優化更新日誌

## 更新日期
2025-01-08

## 主要改動

### 1. CSRF Token 有效期調整
- **舊設定**：5 分鐘 (300秒)
- **新設定**：3 分鐘 (180秒)
- **影響文件**：
  - `newyear2026php/basic/csrf_handler.php`
  - `newyear2026php/getCsrfToken.php`

### 2. Token 使用策略變更（方案二）
- **舊策略**：Token 驗證後立即清除（一次性使用）
- **新策略**：Token 在有效期內可重複使用
- **優點**：
  - 允許網路延遲或重試的情況
  - 用戶體驗更好
  - 仍有 3 分鐘過期保護
  - 配合其他三層防護（Session Token、Turnstile、會員驗證）

### 3. 錯誤訊息優化
所有錯誤訊息改為用戶友善的白話文，並加入錯誤代碼：

#### 安全驗證相關
- ❌ `CSRF token 不存在` → ✅ `系統忙碌中，請稍後再試（E001）`
- ❌ `CSRF token 過期` → ✅ `操作時間過長，請重新操作（E002）`
- ❌ `CSRF token 不匹配` → ✅ `系統驗證失敗，請重新操作（E003）`
- ❌ `Session 不一致` → ✅ `您的登入狀態有誤，請重新登入（E004）`

#### 會員驗證相關
- ❌ `未取得會員資訊` → ✅ `請先登入會員（E101）`
- ❌ `您今天已經占卜過了` → ✅ `今天已經完成占卜了，明天再來吧！（E103）`

#### 機器人驗證相關
- ❌ `機器人驗證失敗` → ✅ `安全驗證失敗，請重新操作（E201）`
- ❌ `驗證已過期` → ✅ `驗證已過期，請重新驗證（E202）`
- ❌ `系統檢測到自動化行為` → ✅ `系統檢測到異常操作，請使用正常方式操作（E203）`

#### 系統錯誤相關
- ❌ `資料庫錯誤` → ✅ `系統忙碌中，請稍後再試（E302）`
- ❌ `系統錯誤` → ✅ `系統發生錯誤，請稍後再試（E901）`

### 4. 前端優化
- 延遲時間從 500ms 調整為 300ms
- 清理過多的調試日誌
- 統一使用「安全驗證」代替「CSRF Token」等工程術語

### 5. 後端日誌優化
- 保留完整的錯誤代碼和詳細資訊（供開發者調試）
- 使用統一格式：`[錯誤代碼] 簡短描述 - 詳細資訊`
- 範例：`[E003] 安全驗證失敗：驗證碼不匹配`

## 錯誤代碼體系

詳見 `ERROR_CODES.md`

- E001-E099：安全驗證相關
- E100-E199：會員驗證相關
- E200-E299：機器人驗證相關
- E300-E399：資料庫相關
- E900-E999：一般錯誤

## 測試建議

1. **正常流程**：確認可以順利完成占卜
2. **網路延遲**：模擬慢速網路，確認重試機制正常
3. **Token 過期**：等待 3 分鐘後操作，應顯示「操作時間過長」
4. **重複占卜**：同一天重複占卜，應顯示「今天已經完成占卜了」

## 安全性評估

### 四層防護機制
1. ✅ **前端 Session Token**：驗證會員一致性
2. ✅ **CSRF Token**：防止跨站請求偽造（3分鐘有效期）
3. ✅ **Turnstile**：防止機器人攻擊
4. ✅ **後端會員驗證**：驗證資料真實性

### 風險評估
- **低風險**：Token 在 3 分鐘內可重複使用
- **可接受理由**：
  - 3 分鐘已經足夠短
  - 其他三層防護仍然有效
  - 大幅提升用戶體驗
  - 減少因網路問題導致的失敗

## 相關文件

- `ERROR_CODES.md` - 錯誤代碼完整對照表
- `newyear2026php/basic/session_config.php` - Session 配置（支援 HTTP/HTTPS）
- `newyear2026php/basic/csrf_handler.php` - CSRF 核心處理邏輯

